# PSMD Singularity Conatainer BETA

**The container version is still in Beta. Please report any bugs on the [issues page](https://github.com/miac-research/psmd/issues).

Using containers can solve problems arising from dependencies and heterogeneous environments.

Singularity is a well-established container solution, developed with scientific computing and deployment on HPC infrastructure (compute cluster) in mind.

This singularity recipe installs FSL 6.0.3 and the latest version of the PSMD script into a container using Ubuntu Bionic as operating system.

> If you want to build the container with a specific version of PSMD, please see the detailed instructions below!

## Instructions

### Prerequisites

- Installation of [singularity](https://sylabs.io) version 3.6 or newer, preferably installed on Linux
- Linux is needed for building the container. A virtual machine setup is available for Windows and Mac users, please consult the [Singularity user guide](https://sylabs.io/docs/) for details.
- After building the container, besides Linux, it can also be executed on macOS using [Singularity Desktop](https://sylabs.io/singularity-desktop-macos/).

### Build the container

- Download the Singularity recipe file `singularity-psmd.txt`
- Build the container `psmd.sif` from the recipe file (using sudo)

```
wget https://raw.githubusercontent.com/miac-research/psmd/main/singularity/singularity-psmd.txt
sudo singularity build psmd.sif singularity-psmd.txt
```

> Please note that the container will be quite large, usually around 2.5 GB. Also note that in order to save space, some parts of the FSL installation are deleted. The container does not contain a fully functional FSL installation, but a minimal install suited for diffusion processing and PSMD calculation. You can modify the recipe file in order to retain a full FSL install.

### Using a specific version of PSMD in the container

By default, the container will use the latest version of the psmd script from the repository. To run a specific version (from a specific release, you need to edit the recipe file. Find the following line: `wget -O /psmd/psmd.sh https://raw.githubusercontent.com/miac-research/psmd/main/psmd.sh` and substitute the URL with one of the following URLs:

| version | URL |
| ---     | --- |
| 1.0     | https://raw.githubusercontent.com/miac-research/psmd/8f6b1495a65972111ec099b7f304d9f3954bd983/psmd.sh | 
| 1.5.1   | https://raw.githubusercontent.com/miac-research/psmd/d0de74fe0b190d04588b934981c7464334f83b9f/psmd.sh |
| 1.7     | tbd |


### Run the container

- In general, on a system with Singularity or Singularity Desktop, run with:

```bash
singularity exec psmd.sif psmd.sh
```

- After this command, specify the options as usually for the psmd script (see [www.psmd-marker.com](https://www.psmd-marker.com) for details on available options), e.g.

```bash
singularity exec psmd.sif psmd.sh -d data.nii.gz -b data.bvals \
  -r data.bvecs -s skeleton_mask_2019.nii.gz 
```

- The container has access only to the current folder of your system, where you are running the command. If your data (or the skeleton) is in another folder, you need to make the folder available to the container using the bind option `-B` of singularity.

- The following example works if subjectA (from the example subjects provided in this repository) is located at `/home/user/subjectA` and the skeleton mask is located at `/home/user`.

```bash
datafolder=/home/user/subjectA
skeletonfolder=/home/user
singularity exec -B ${datafolder} -B ${skeletonfolder} psmd.sif psmd.sh \
  -f ${datafolder}/subjectA_FA.nii.gz -m ${datafolder}/subjectA_MD.nii.gz \
  -s ${skeletonfolder}/skeleton_mask_2019.nii.gz
```

## Acknowledgements

The container recipe was in part generated by [Neurodocker](https://github.com/ReproNim/neurodocker).

## License

The container will contain an (incomplete) FSL installation. Please make sure to comply with the [FSL license conditions](https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Licence). Especially commercial use requires a paid license of FSL!