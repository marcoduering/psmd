# PSMD Singularity Conatiner

Using containers can solve issues arising from dependencies and heterogeneous environments.

Singularity is a well-established container solution, developed with scientific computing and deployment on HPC infrastructure (compute cluster) in mind.

## Instructions

### Prerequisites

- Installation of [singularity](https://sylabs.io) version 3.6 or newer, preferably installed on Linux
- Linux is needed for building the container. A virtual machine setup is available for Windows and Mac users, please consult the [Singularity user guide](https://sylabs.io/docs/) for details.
- After building, the built container can also be executed on macOS using [Singularity Desktop](https://sylabs.io/singularity-desktop-macos/).

### Build the container

- Download the Singularity recipe file `singularity-psmd.txt`
- To build the container `psmd.sif` from the recipe, run

```
singularity build psmd.sif singularity-psmd.txt
```

> Please note that the container will be quite large, usually around 1.7 GB. Also note that in order to save space, some parts of the FSL installation were deleted. The container does not contain a fully functional FSL installation, but a minimal install suited for diffusion processing and PSMD calculation. Change the recipe file if you want to change this!

### Run the container

- In general, on a system with Singularity or Singularity Desktop, run with:

```bash
singularity exec psmd.sif psmd.sh
```

- After this command, specify the options as usually for the psmd script, e.g.

```bash
singularity exec psmd.sif psmd.sh -d data.nii.gz -b data.bvals \
  -r data.bvecs -s skeleton_mask_2019.nii.gz 
```

- The container has access only to the current folder of your system, where you are running the command. If your data (or the skeleton) is in another folder, you need to make the folder available to the container using the bind option `-B` of singularity: 

```bash
datafolder=/path/to/data
skeletonfolder=/path/to/skeleton
singularity exec -B ${datafolder} -B ${skeletonfolder} psmd.sif psmd.sh \
  -d ${datafolder}/data.nii.gz -b ${datafolder}/data.bvals -r ${datafolder}/data.bvecs \
  -s ${skeletonfolder}/skeleton_mask_2019.nii.gz
```

## Acknowledgements

The container recipe was in part generated by [Neurodocker](https://github.com/ReproNim/neurodocker).

## License

The container will contain an FSL installation. Please make sure to comply with the [FSL license conditions](https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Licence). Especially commercial use required a paid license of FSL!