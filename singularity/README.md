# PSMD Singularity Conatainer

**Please report any bugs with the Singularity container on the [issues page](https://github.com/miac-research/psmd/issues).**

Using containers can solve problems arising from dependencies and heterogeneous environments.

Singularity is a well-established container solution, developed with scientific computing and deployment on HPC infrastructure (compute cluster) in mind.

This singularity recipe installs FSL 6.0.3 and the latest version of the PSMD script into a container using Ubuntu Bionic as operating system.

> If you want to build the container with a specific version of PSMD, please see the detailed instructions below. Alternatively, you can use a psmd main script outside the container and start it with the container.

## IMPORTANT DISCLAIMER  

PSMD is NOT a medical device and therefore **for research use only**. Do not use PSMD for diagnosis, prognosis, monitoring or any other clinical routine use. Any application of the psmd script in clinical routine is forbidden by law, e.g. by Medical Device Regulation article 5 in the EU.

## Instructions

### Prerequisites

- Linux operating system (e.g. inside a virutal machine)
- Installation of [singularity](https://sylabs.io) version 3.6 or newer

### Build the container

- Download the Singularity recipe file `singularity-psmd.txt`
- Build the container `psmd.sif` from the recipe file (as root or using sudo)

```
wget https://raw.githubusercontent.com/miac-research/psmd/main/singularity/singularity-psmd.txt
sudo singularity build psmd.sif singularity-psmd.txt
```

> Please note that the container will be quite large, usually around 2.5 GB. Also note that in order to save space, some parts of the FSL installation are deleted. The container does not contain a fully functional FSL installation, but a minimal install suited for diffusion processing and PSMD calculation. You can modify the recipe file in order to retain a full FSL install.

### Using a specific version of PSMD in the container

By default, the container will use the latest version of the psmd script from the repository. To run a specific version (from a specific release, you need to edit the recipe file. Find the following line: `wget -O /psmd/psmd.sh https://raw.githubusercontent.com/miac-research/psmd/main/psmd.sh` and substitute the URL with one of the following URLs:

| version | URL |
| ---     | --- |
| 1.0     | https://raw.githubusercontent.com/miac-research/psmd/v1.0/psmd.sh | 
| 1.5.1   | https://raw.githubusercontent.com/miac-research/psmd/v1.5.1/psmd.sh |
| 1.7     | https://raw.githubusercontent.com/miac-research/psmd/v1.7/psmd.sh |
| 1.8.2   | https://raw.githubusercontent.com/miac-research/psmd/v1.8.2/psmd.sh |


### Run the container

- In general, on a system with Singularity or Singularity Desktop, run with:

```bash
singularity exec psmd.sif psmd.sh
```

- After this command, specify the options as usually for the psmd script (see [www.psmd-marker.com](https://www.psmd-marker.com) for details on available options), e.g.

```bash
singularity exec -B $(pwd) psmd.sif psmd.sh -d data.nii.gz -b data.bvals \
  -r data.bvecs -s skeleton_mask_2019.nii.gz 
```

- **IMPORTANT**: By default, the container has access only to your home folder. If your data (or the skeleton) is in another folder, you need to make the folder available to the container using the bind option `-B` of Singularity. This is why `-B $(pwd)` was added to the command above. It will bind the current folder into the container.

- You can also bind specific paths to the container. The following example works if subjectA (from the example subjects provided in this repository) is located at `/home/user/subjectA` and the skeleton mask is located at `/home/user/skeleton`.

```bash
datafolder=/home/user/subjectA
skeletonfolder=/home/user/skeleton
singularity exec -B ${datafolder} -B ${skeletonfolder} psmd.sif psmd.sh \
  -f ${datafolder}/subjectA_FA.nii.gz -m ${datafolder}/subjectA_MD.nii.gz \
  -s ${skeletonfolder}/skeleton_mask_2019.nii.gz
```

## Acknowledgements

The container recipe was in part generated by [Neurodocker](https://github.com/ReproNim/neurodocker).

## License

While PSMD depends on FSL, it is not part of FSL. FSL is only used as a "library" when installed into the container. The container will thus contain an (incomplete) FSL installation. Please make sure to comply with the [FSL license conditions](https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Licence). **Especially commercial use requires a paid license of FSL!**

